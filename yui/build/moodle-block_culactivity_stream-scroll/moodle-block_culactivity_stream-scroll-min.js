YUI.add("moodle-block_culactivity_stream-scroll",function(e,t){M.block_culactivity_stream=M.block_culactivity_stream||{},M.block_culactivity_stream.scroll={limitnum:null,count:null,courseid:null,scroller:null,timer:null,init:function(t){e.one(".pages")&&e.one(".pages").hide();var n=e.one(e.config.doc);try{var r=e.one(".block_culactivity_stream .reload"),i=e.one(".block_culactivity_stream"),s=i.get("id");s=s.replace("inst","");var o=e.one("#instance-"+s+"-header");o.append(r),r.setStyle("display","inline-block"),n.delegate("click",this.reloadblock,".block_culactivity_stream_reload",this)}catch(u){}n.delegate("click",this.removenotification,".block_culactivity_stream .removelink",this),this.scroller=e.one(".block_culactivity_stream .culactivity_stream"),this.scroller.on("scroll",this.filltobelowblock,this),this.limitnum=t.limitnum,this.count=t.count,this.courseid=t.courseid,this.returnurl=t.returnurl,this.instanceid=t.instanceid,this.timer=e.later(3e5,this,this.reloadnotifications,[],!0),this.filltobelowblock()},filltobelowblock:function(){var t=this.scroller.get("scrollHeight"),n=this.scroller.get("scrollTop"),r=this.scroller.get("clientHeight"),i;if(t-(n+r)<10){this.timer.cancel();var s=e.all(".block_culactivity_stream .notifications li").size();if(s>0){var o=e.all(".block_culactivity_stream .notifications li").item(s-1);i=o.get("id").split("_")[1]}else i=0;this.addnotifications(s,i),this.timer=e.later(3e5,this,this.reloadnotifications,[],!0)}},reloadblock:function(e){e.preventDefault(),this.reloadnotifications(e)},addnotifications:function(t,n){if(t<=this.count){this.scroller.detach("scroll"),e.one(".block_culactivity_stream_reload").setStyle("display","none"),e.one(".block_culactivity_stream_loading").setStyle("display","inline-block");var r={sesskey:M.cfg.sesskey,limitfrom:0,limitnum:this.limitnum,lastid:n,newer:!1,courseid:this.courseid,returnurl:this.returnurl,instanceid:this.instanceid};e.io(M.cfg.wwwroot+"/blocks/culactivity_stream/scroll_ajax.php",{method:"POST",data:window.build_querystring(r),context:this,on:{success:function(t,n){var r=e.JSON.parse(n.responseText);r.error?this.timer.cancel():e.one(".block_culactivity_stream .notifications").append(r.output),r.end||this.scroller.on("scroll",this.filltobelowblock,this),e.one(".block_culactivity_stream_loading").setStyle("display","none"),e.one(".block_culactivity_stream_reload").setStyle("display","inline-block")},failure:function(){e.one(".block_culactivity_stream_loading").setStyle("display","none"),e.one(".block_culactivity_stream_reload").setStyle("display","inline-block"),this.timer.cancel()}}})}},reloadnotifications:function(){var t=0;this.scroller.one("li")&&(t=this.scroller.one("li").get("id").split("_")[1]),e.one(".block_culactivity_stream_reload").setStyle("display","none"),e.one(".block_culactivity_stream_loading").setStyle("display","inline-block");var n={sesskey:M.cfg.sesskey,lastid:t,courseid:this.courseid,returnurl:this.returnurl,instanceid:this.instanceid};e.io(M.cfg.wwwroot+"/blocks/culactivity_stream/reload_ajax.php",{method:"POST",data:window.build_querystring(n),context:this,on:{success:function(t,n){var r=e.JSON.parse(n.responseText);r.error?this.timer.cancel():(e.one(".block_culactivity_stream .notifications").prepend(r.output),this.count=this.count+r.count),e.one(".block_culactivity_stream_loading").setStyle("display","none"),e.one(".block_culactivity_stream_reload").setStyle("display","inline-block")},failure:function(){e.one(".block_culactivity_stream_loading").setStyle("display","none"),e.one(".block_culactivity_stream_reload").setStyle("display","inline-block"),this.timer.cancel()}}})},removenotification:function(t){t.preventDefault();var n=t.target,r=n.get("href").split("?"),i=r[1],s=e.QueryString.parse(i);e.io(M.cfg.wwwroot+"/blocks/culactivity_stream/remove_ajax.php",{method:"POST",data:i,context:this,on:{success:function(){e.one("#m_"+s.remove).next().remove(!0),e.one("#m_"+s.remove).remove(!0)}}})}}},"@VERSION@",{requires:["base","node","io","json-parse","dom-core","querystring","event-custom","moodle-core-dock"]});
